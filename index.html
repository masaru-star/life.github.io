<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ´»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ from masaru__</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            padding: 20px;
            background-color: #f0f2f5;
            user-select: none;
        }
        #selected-person-panel .stat-bar.relationship {
            display: flex;
            align-items: center;
            height: 15px;
            border-radius: 3px;
            margin-bottom: 8px;
            background-color: #e9ecef; /* ãƒ™ãƒ¼ã‚¹ã®èƒŒæ™¯è‰² */
            position: relative;
            overflow: hidden; /* å­è¦ç´ ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
        }
        #selected-person-panel .stat-bar.relationship::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #aaa; 
            transform: translateX(-50%);
            z-index: 2;
        }
        #selected-person-panel .stat-bar.relationship > div {
            height: 100%;
            position: absolute;
            z-index: 1;
            transition: width 0.3s, margin-left 0.3s;
        }

        #game-world {
            display: flex;
            gap: 20px;
        }

        #room-container {
            position: relative;
            width: 360px;
            height: 360px;
            border: 2px solid #333;
            background-color: #fdfdfd;
            overflow: hidden;
        }

        #room-grid {
            display: grid;
            grid-template-columns: repeat(12, 30px);
            grid-template-rows: repeat(12, 30px);
            position: absolute;
            top: 0;
            left: 0;
        }

        .grid-tile {
            width: 30px;
            height: 30px;
            border: 1px solid #eee;
            box-sizing: border-box; /* æ ç·šã‚’å«ã‚ã¦30pxã«ã™ã‚‹ */
        }
        
        .furniture-tile {
            background-color: #ccc; /* å®¶å…·ãŒã‚ã‚‹å ´æ‰€ã®è‰² */
            border: 1px solid #999;
        }
        .furniture-tile.selected-for-move {
            background-color: #ffda63; /* ç§»å‹•é¸æŠä¸­ã®å®¶å…·ã®è‰² */
            border: 2px dashed #e69d00;
        }


        #character-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã‚’å¦¨ã’ãªã„ã‚ˆã†ã« */
        }

        .person {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #000;
            transition: transform 0.5s linear; /* ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹• */
            box-sizing: border-box;
            background-color: #fff; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
            pointer-events: auto; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã« */
            cursor: pointer;
            
            /* åå‰è¡¨ç¤ºç”¨ */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: white;
            text-shadow: 1px 1px 1px #000;
        }
        .person.male { background-color: #6495ED; } /* ç”·æ€§ */
        .person.female { background-color: #FF69B4; } /* å¥³æ€§ */
        .person.other { background-color: #90EE90; } /* ãã®ä»– */

        .person-speech {
            position: absolute;
            bottom: 22px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ccc;
            padding: 2px 5px;
            border-radius: 5px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #ui-panel {
            width: 300px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #time-controls button, #action-controls button {
            width: 100%;
            padding: 10px;
            font-size: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.2s;
        }
        #time-controls button:hover, #action-controls button:hover {
            background-color: #0056b3;
        }
        #time-controls button.ticking {
            background-color: #dc3545;
        }
        #time-controls button.ticking:hover {
            background-color: #a71d2a;
        }

        #design-mode-btn.active {
            background-color: #28a745;
        }
        #design-mode-btn.active:hover {
            background-color: #218838;
        }

        #info-panel div {
            font-size: 16px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        #info-panel div:last-child {
            border-bottom: none;
        }

        #selected-person-panel {
            min-height: 100px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
        #selected-person-panel h4 { margin: 0 0 10px 0; }
        #selected-person-panel .stat-bar {
            width: 100%;
            background: #eee;
            height: 15px;
            border-radius: 3px;
            margin-bottom: 3px;
        }
        #selected-person-panel .stat-bar > div {
            height: 100%;
            background: #4CAF50;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .stat-label { font-size: 12px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            width: 300px;
        }
        .modal h3 { margin-top: 0; }
        .modal label {
            display: block;
            margin-bottom: 5px;
        }
        .modal input, .modal select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .modal button {
            padding: 8px 15px;
            margin-right: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal button:hover {
            background-color: #0056b3;
        }
        .modal button#cancel-add-person,
        .modal button#exit-design-mode-btn,
        .modal button#cancel-job-btn {
            background-color: #6c757d;
        }
        .modal button#cancel-add-person:hover,
        .modal button#exit-design-mode-btn:hover,
        .modal button#cancel-job-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div id="game-world">
        
        <div id="room-container">
            <div id="room-grid"></div>
            <div id="character-layer"></div>
        </div>

        <div id="ui-panel">
            <div id="time-controls" style="margin-bottom: 15px;">
                <button id="time-toggle-btn">æ™‚é–“ã‚’é€²ã‚ã‚‹</button>
            </div>
            <h3>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
            <div id="info-panel" style="margin-bottom: 15px;">
                <div id="time-display">æ™‚åˆ»: 0æ—¥ç›® 06:00</div>
                <div id="money-display">æ‰€æŒé‡‘: 10000 G</div>
                <div id="resource-display">æ°´: 0 / é›»: 0</div>
            </div>
            <div id="selected-person-panel">
                <div id="person-details">ï¼ˆéƒ¨å±‹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠï¼‰</div>
            </div>
            
            <div style="margin-top: 15px;">
                <h4>ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ ãƒ‡ãƒ¼ã‚¿</h4>
                <textarea id="save-data-area" rows="5" style="width: 100%; box-sizing: border-box;"></textarea>
            </div>
            <div id="action-controls">
                <button id="add-person-btn">äººã‚’è¿½åŠ </button>
                <button id="design-mode-btn">æ¨¡æ§˜æ›¿ãˆ</button>
                <button id="save-game-btn">ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜</button>
                <button id="load-game-btn">ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿</button>
            </div>
            <div id="design-mode-status" style="min-height: 16px; font-weight: bold;"></div>

        </div> </div> <div id="add-person-modal-backdrop" class="modal-backdrop">
        <div class="modal">
            <h3>æ–°ã—ã„äººã‚’è¿½åŠ </h3>
            <label for="p-firstname">å:</label>
            <input type="text" id="p-firstname" value="å¤ªéƒ">
            
            <label for="p-lastname">å§“:</label>
            <input type="text" id="p-lastname" value="ç”°ä¸­">
            
            <label for="p-gender">æ€§åˆ¥:</label>
            <select id="p-gender">
                <option value="male">ç”·æ€§</option>
                <option value="female">å¥³æ€§</option>
                <option value="other">ãã®ä»–</option>
            </select>
            
            <label for="p-orientation">æ‹æ„›å¯¾è±¡:</label>
            <select id="p-orientation">
                <option value="hetero">ç•°æ€§æ„›</option>
                <option value="homo">åŒæ€§æ„›</option>
            </select>

            <label for="p-trait">ç‰¹è³ª:</label>
            <select id="p-trait"></select>
            <button id="confirm-add-person">æ±ºå®š</button>
            <button id="cancel-add-person">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
    
    <div id="design-mode-modal-backdrop" class="modal-backdrop">
        <div class="modal">
            <h3>æ¨¡æ§˜æ›¿ãˆ</h3>
            <label for="furniture-select">è³¼å…¥ã™ã‚‹å®¶å…·:</label>
            <select id="furniture-select"></select>
            
            <label for="f-grid-x">è¨­ç½® Xåº§æ¨™ (0-11):</label>
            <input type="number" id="f-grid-x" min="0" max="19" value="0">
            
            <label for="f-grid-y">è¨­ç½® Yåº§æ¨™ (0-11):</label>
            <input type="number" id="f-grid-y" min="0" max="19" value="0">
            
            <p id="furniture-info">ä¾¡æ ¼: 0 G</p>

            <button id="buy-furniture-btn">è³¼å…¥ãƒ»è¨­ç½®</button>
            <button id="exit-design-mode-btn">çµ‚äº†</button>
            <p><small>â€»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å®¶å…·ã‚’é¸æŠã—ã€ã‚¯ãƒªãƒƒã‚¯ã§ç§»å‹•ã§ãã¾ã™ã€‚</small></p>
        </div>
    </div>
    
    <div id="job-modal-backdrop" class="modal-backdrop">
        <div class="modal">
            <h3 id="job-modal-title">ä»•äº‹ã‚’é¸ã¶</h3>
            <label for="job-select">è·æ¥­:</label>
            <select id="job-select"></select>
            <button id="assign-job-btn">å°±è·</button>
            <button id="quit-job-btn">é€€è·</button>
            <button id="cancel-job-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script>
// === JavaScriptã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===

        // --- å®šæ•°ãƒ»è¨­å®š ---
        const ROOM_WIDTH = 12; // 20 ã‹ã‚‰ 12 ã«å¤‰æ›´
        const ROOM_HEIGHT = 12; // 20 ã‹ã‚‰ 12 ã«å¤‰æ›´
        const TILE_SIZE = 30; // 1ã‚¿ã‚¤ãƒ«ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º
        const REAL_SEC_PER_GAME_MIN = 1 / 3; // ãƒªã‚¢ãƒ«1ç§’ = ã‚²ãƒ¼ãƒ å†…3åˆ† (å®Ÿéš›ã¯100msã”ã¨ã«è¨ˆç®—)
        const MS_PER_GAME_MINUTE = 1000 / (3 / REAL_SEC_PER_GAME_MIN); // 1ã‚²ãƒ¼ãƒ åˆ†é€²ã‚€ã®ã«å¿…è¦ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒŸãƒªç§’

        // å®¶å…·ã®å®šç¾©
        const FURNITURE_TYPES = {
            laptop: { name: "ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³", width: 1, height: 1, price: 1000, power: 5, use: (p) => { p.stats.fun = Math.min(100, p.stats.fun + 7); p.showSpeech("æ¥½ã—ã„ï¼"); }, duration: 60 },
            microwave: { name: "é›»å­ãƒ¬ãƒ³ã‚¸", width: 1, height: 1, price: 400, power: 2, use: (p) => { if (gameState.money >= 75) { gameState.money -= 8; p.stats.hunger += 80; p.showSpeech("ãŠã„ã—ã„ï¼(8G)"); } else { p.showSpeech("ãŠé‡‘ãŒãªã„..."); } } },
            bed: { name: "ãƒ™ãƒƒãƒ‰", width: 2, height: 1, price: 200, power: 0, water: 0, use: (p) => { p.stats.energy = 100; p.showSpeech("Zzz..."); }, duration: 7 * 60 },
            bath: { name: "é¢¨å‘‚", width: 2, height: 1, price: 200, water: 2, use: (p) => { p.stats.hygiene = 100; p.showSpeech("ã•ã£ã±ã‚Š"); }, duration: 30 },
            shower: { name: "ã‚·ãƒ£ãƒ¯ãƒ¼", width: 1, height: 1, price: 200, water: 1, use: (p) => { p.stats.hygiene = 100; p.showSpeech("ã‚¹ãƒƒã‚­ãƒª"); }, duration: 15 },
            grill: { name: "ã‚°ãƒªãƒ«", width: 1, height: 1, price: 1200, power: 5, water: 0, use: (p) => { /* ã‚°ãƒªãƒ«ä½¿ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã¯Person.handleActionã§å‡¦ç† */ } },
        };
         // å®¶å…·ã®è‰²å®šç¾© (å¤‰æ›´ã•ã‚ŒãŸå®¶å…·ã®è‰²ã®åŒºåˆ¥ã®ãŸã‚)
         const FURNITURE_COLORS = {
                laptop: '#444444',
                microwave: '#F0E68C',
                bed: '#D8BFD8',
                bath: '#ADD8E6',
                shower: '#B0C4DE',
                grill: '#DC143C',
         };

            // ç‰¹è³ªã¨ç›¸æ€§ã®å®šç¾© (æ–°è¦è¿½åŠ )
         const TRAITS = {
                gentle: { name: "å„ªã—ã„", good: ["gentle", "shy"], bad: ["mischievous"] },
                mischievous: { name: "ã„ãŸãšã‚‰å¥½ã", good: ["mischievous"], bad: ["shy"] },
                shy: { name: "äººè¦‹çŸ¥ã‚Š", good: ["gentle"], bad: ["serious", "otaku"] },
                serious: { name: "çœŸé¢ç›®", good: ["serious", "otaku"], bad: ["gentle"] },
                otaku: { name: "ãƒ²ã‚¿ã‚¯", good: ["otaku", "gentle"], bad: ["shy"] },
         };
        // è·æ¥­ã®å®šç¾© (æ™‚åˆ»ã¯åˆ†å˜ä½)
        const JOBS = {
            none: { name: "ç„¡è·", start: 0, end: 0, pay: 0 },
            part_time_day: { name: "ã‚¢ãƒ«ãƒã‚¤ãƒˆ(æ˜¼é–“)", start: 9 * 60, end: 11 * 60, pay: 80 },
            part_time_night: { name: "ã‚¢ãƒ«ãƒã‚¤ãƒˆ(å¤œé–“)", start: 20 * 60, end: 22 * 60, pay: 100 },
            office_worker: { name: "ä¼šç¤¾å“¡", start: 10 * 60, end: 16 * 60, pay: 130 },
            entertainer: { name: "ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒŠãƒ¼", start: 13*60, end: 17*60, pay: 80},
        };

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let gameState = {
            time: new Date(2025, 0, 1, 6, 0, 0), // ã‚²ãƒ¼ãƒ å†…æ™‚é–“ (6æ™‚ã‚¹ã‚¿ãƒ¼ãƒˆ)
            money: 10000,
            dailyWater: 0,
            dailyPower: 0,
            isRunning: false,
            lastUpdateTimestamp: Date.now(), // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®æœ€çµ‚æ›´æ–°æ™‚åˆ»
            accumulatedTimeMs: 0, // è“„ç©ã•ã‚ŒãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒŸãƒªç§’
            isDesignMode: false,
            foodInventory: { // æ–™ç†ä¿å­˜ç®±
            servings: 0,  // é£Ÿæ•°
            quality: 0,   // å“è³ª (1é£Ÿã‚ãŸã‚Šã®æº€è…¹åº¦å›å¾©é‡)
            }
        };

        let people = []; // {id, data: Person}
        let furniture = []; // {id, data: Furniture}
        let roomGrid = Array(ROOM_HEIGHT).fill(null).map(() => Array(ROOM_WIDTH).fill(null)); // å®¶å…·ã®é…ç½®æƒ…å ± (null or furniture.id)
        let selectedPerson = null;
        let gameLoopRAF = null; // requestAnimationFrame ã®ID

        let nextPersonId = 0;
        let nextFurnitureId = 0;

        let selectedFurnitureForMove = null; // ç§»å‹•é¸æŠä¸­ã®å®¶å…·

        // --- DOMè¦ç´  ---
        const roomGridEl = document.getElementById('room-grid');
        const characterLayerEl = document.getElementById('character-layer');
        const timeDisplayEl = document.getElementById('time-display');
        const moneyDisplayEl = document.getElementById('money-display');
        const resourceDisplayEl = document.getElementById('resource-display');
        const timeToggleBtn = document.getElementById('time-toggle-btn');
        const addPersonBtn = document.getElementById('add-person-btn');
        const designModeBtn = document.getElementById('design-mode-btn');
        const designModeStatusEl = document.getElementById('design-mode-status');
        const personDetailsEl = document.getElementById('person-details');
        const saveGameBtn = document.getElementById('save-game-btn');
        const loadGameBtn = document.getElementById('load-game-btn');
        const saveDataArea = document.getElementById('save-data-area');
        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        const addPersonModal = document.getElementById('add-person-modal-backdrop');
        const designModal = document.getElementById('design-mode-modal-backdrop');
        const jobModal = document.getElementById('job-modal-backdrop');
        const furnitureSelect = document.getElementById('furniture-select');
        const furnitureInfo = document.getElementById('furniture-info');
        const jobSelect = document.getElementById('job-select');

        // --- ã‚¯ãƒ©ã‚¹å®šç¾© ---

        /**
         * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹
         */
        class Person {
            constructor(id, firstName, lastName, gender, orientation, traitKey) {
                this.id = id;
                this.firstName = firstName;
                this.lastName = lastName;
                this.gender = gender;
                this.orientation = orientation;
                this.traitKey = traitKey || this.getRandomTraitKey(); // ç‰¹è³ª
                this.trait = TRAITS[this.traitKey];
                this.birthDate = new Date(gameState.time.getTime()); // ä½œæˆæ—¥ã‚’èª•ç”Ÿæ—¥ã¨ã—ã¦è¨˜éŒ²
                const charSize = 20; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚µã‚¤ã‚º (CSSã‚ˆã‚Š)
                this.x = Math.random() * (ROOM_WIDTH * TILE_SIZE - charSize); // ä¿®æ­£
                this.y = Math.random() * (ROOM_HEIGHT * TILE_SIZE - charSize); // ä¿®æ­£

                this.stats = {
                    hunger: 80, // é£Ÿæ¬² (100æº€è…¹ -> 0ç©ºè…¹)
                    energy: 80, // ç¡çœ æ¬² (100å…ƒæ°— -> 0çœ ã„)
                    hygiene: 80, // æ¸…æ½” (100æ¸…æ½” -> 0ä¸æ½”)
                    fun: 80,     // æ¥½ã—ã• (100æ¥½ã—ã„ -> 0é€€å±ˆ)
                };
                
                this.job = JOBS.none;
                this.isWorking = false;
                this.relationships = {}; // ä»–ã®person.idã¨ã®é–¢ä¿‚å€¤ (-100 ~ 100)
                this.skills = {
                    talk: { level: 0, exp: 0 },
                    game: { level: 0, exp: 0 },
                    job: { level: 0, exp: 0 },
                    cook: { level: 0, exp: 0 },
                };
                this.currentAction = null; // ä¾‹: { type: 'sleep', target: furniture, duration: 420 }
                this.lastExpCheckTime = 0;
                this.targetPosition = null; // ç§»å‹•ç›®æ¨™ã® {x, y}
                this.moveSpeed = 1.2; // 1ã‚²ãƒ¼ãƒ åˆ†ã‚ãŸã‚Šã®ç§»å‹•ãƒ”ã‚¯ã‚»ãƒ«æ•°
                this.initDOM();
            }
            get nameKey() {
                return `${this.lastName}_${this.firstName}_${this.id}`;
            }

            getRandomTraitKey() {
                const keys = Object.keys(TRAITS);
                return keys[Math.floor(Math.random() * keys.length)];
            }
            
            isBirthday() {
                const daysPassed = Math.floor((gameState.time - this.birthDate) / (1000 * 60 * 60 * 24));
                return daysPassed > 0 && daysPassed % 30 === 0;
            }
            toSaveData() {
                return {
                    id: this.id,
                    firstName: this.firstName,
                    lastName: this.lastName,
                    gender: this.gender,
                    orientation: this.orientation,
                    x: this.x,
                    y: this.y,
                    stats: this.stats,
                    jobKey: Object.keys(JOBS).find(key => JOBS[key] === this.job), // jobã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãªãã‚­ãƒ¼ã‚’ä¿å­˜
                    isWorking: this.isWorking,
                    relationships: this.relationships,
                    traitKey: this.traitKey,
                    birthDate: this.birthDate.getTime(),
                    skills: this.skills,
                };
            }
            
            // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒ
            static fromSaveData(data) {
                // DOMåˆæœŸåŒ–ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹
                const person = new Person(
                    data.id, 
                    data.firstName, 
                    data.lastName, 
                    data.gender, 
                    data.orientation,
                    data.traitKey
                );
                
                person.x = data.x;
                person.y = data.y;
                person.stats = data.stats;
                person.job = JOBS[data.jobKey || 'none'];
                person.isWorking = data.isWorking;
                person.relationships = data.relationships;
                if (data.birthDate) {
                    person.birthDate = new Date(data.birthDate);
                }
                person.trait = TRAITS[data.traitKey] || TRAITS[person.getRandomTraitKey()];
                person.skills = data.skills || { talk: { level: 0, exp: 0 }, game: { level: 0, exp: 0 }, job: { level: 0, exp: 0 }, cook: { level: 0, exp: 0 } };
                // å¾©å…ƒå¾Œã®ä½ç½®ã«DOMã‚’å†æç”»
                person.draw(); 
                
                return person;
            }

            initDOM() {
                this.element = document.createElement('div');
                this.element.className = `person ${this.gender}`;
                this.element.id = `person-${this.id}`;
                this.element.innerText = this.firstName.charAt(0); // ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«
                this.element.onclick = (e) => {
                    e.stopPropagation(); // è¦ª(éƒ¨å±‹)ã¸ã®ã‚¯ãƒªãƒƒã‚¯ä¼æ’­ã‚’é˜²ã
                    selectPerson(this);
                };
                
                this.speechBubble = document.createElement('div');
                this.speechBubble.className = 'person-speech';
                this.element.appendChild(this.speechBubble);
                
                characterLayerEl.appendChild(this.element);
                this.draw();
            }

            // AIã¨çŠ¶æ…‹ã®æ›´æ–°
            update(gameMinutesPassed) {
                if (this.isBirthday()) {
                    this.showSpeech("ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ï¼ğŸ‰");
                }
                if (this.isWorking) {
                    this.checkWorkEnd();
                    return; // ä»•äº‹ä¸­ã¯ä»–ã®ã“ã¨ã‚’ã—ãªã„
                }

                // 1. æ¬²æ±‚ã®æ¸›å°‘
                this.updateNeeds(gameMinutesPassed);

                // 2. ç¾åœ¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡¦ç†
                if (this.currentAction) {
                    this.handleAction(gameMinutesPassed);
                    return; // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­ã¯ä»–ã®AIã¯å‹•ã‹ãªã„
                }
                
                // 3. ç§»å‹•å‡¦ç†
                if (this.targetPosition) {
                    this.move(gameMinutesPassed);
                    return; // ç§»å‹•ä¸­ã¯ä»–ã®AIã¯å‹•ã‹ãªã„
                }

                // 4. æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ±ºå®š (AI)
                this.findNewAction();
            }

            // æ¬²æ±‚ã®æ¸›å°‘
            updateNeeds(gameMinutesPassed) {
                this.stats.hunger = Math.max(0, this.stats.hunger - (gameMinutesPassed / 60) * 2); // 2æ™‚é–“ã§ç´„4æ¸›å°‘
                this.stats.energy = Math.max(0, this.stats.energy - (gameMinutesPassed / 60) * 1);
                this.stats.hygiene = Math.max(0, this.stats.hygiene - (gameMinutesPassed / 60) * 1);
                this.stats.fun = Math.max(0, this.stats.fun - (gameMinutesPassed / 60) * 1.5);
            }

            // AI: æ¬¡ã®è¡Œå‹•ã‚’æ±ºã‚ã‚‹
            findNewAction() {
                // å„ªå…ˆé †ä½1: ç·Šæ€¥ã®æ¬²æ±‚ (é£Ÿäº‹ > ç¡çœ  > æ¸…æ½”)
                if (this.stats.hunger < 30) {
        // 1. ä¿å­˜ç®±ã®æ–™ç†ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ï¼‰
        if (this.tryUseFoodInventory()) return; // <--- æ–°è¦
        
        // 2. ã‚°ãƒªãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆèª¿ç†ï¼‰
        if (this.tryFindAndUseFurniture('grill')) return; // <--- æ–°è¦

        // 3. é›»å­ãƒ¬ãƒ³ã‚¸ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆåº¦ã‚’ä¸‹ã’ã‚‹ï¼‰
        if (this.tryFindAndUseFurniture('microwave')) return; 
                }
                if (this.stats.energy < 20) {
                    if (this.tryFindAndUseFurniture('bed')) return;
                }
                if (this.stats.hygiene < 30) {
                    if (this.tryFindAndUseFurniture('shower') || this.tryFindAndUseFurniture('bath')) return;
                }
                // ä¼šè©±ç›¸æ‰‹ã‚’æ¢ã™
                let talkTarget = this.findTalkPartner();
                if (talkTarget) {
                    let targetPos = this.getInteractionPoint(talkTarget);
                    this.setTargetPosition(targetPos.x, targetPos.y, () => {
                        this.startConversation(talkTarget);
                    });
                    return;
                }
                
                // ä¼šè©±ç›¸æ‰‹ãŒã„ãªã„ãªã‚‰PC (ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³)
                if (this.tryFindAndUseFurniture('laptop')) return;

                // å„ªå…ˆé †ä½3: ãƒ©ãƒ³ãƒ€ãƒ ãªç§»å‹• (è¦æœ›: å¸¸ã«å‹•ãå›ã‚‹)
                // ä¸Šè¨˜ã®è¡Œå‹•ã‚’ä½•ã‚‚è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆã€å¿…ãšãƒ©ãƒ³ãƒ€ãƒ ã«ç§»å‹•ã™ã‚‹ (ç¢ºç‡ã‚’æ’¤å»ƒ)
                const charSize = 20;
                this.setTargetPosition(
                    Math.random() * (ROOM_WIDTH * TILE_SIZE - charSize), // ä¿®æ­£
                    Math.random() * (ROOM_HEIGHT * TILE_SIZE - charSize) // ä¿®æ­£
                );
            }

            // å®¶å…·ã‚’æ¢ã—ã¦ä½¿ç”¨è©¦è¡Œ
            tryFindAndUseFurniture(typeKey) {
                const targetFurniture = furniture.find(f => f.type === typeKey && !f.isUsed);
                if (targetFurniture) {
                    targetFurniture.isUsed = true; // ã™ãã«ä½¿ç”¨ä¸­ã«ã—ã¦ä»–ã®äººãŒä½¿ã‚ãªã„ã‚ˆã†ã«
                    let usePos = targetFurniture.getUsePosition();
                    
                    this.setTargetPosition(usePos.x, usePos.y, () => {
                        // åˆ°ç€å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        const definition = FURNITURE_TYPES[typeKey];
                        let duration = definition.duration || 5;
                        this.currentAction = {
                            type: definition.name,
                            target: targetFurniture,
                            duration: duration, // ç¶™ç¶šæ™‚é–“ (åˆ†)
                            timer: 0,
                            useFunc: definition.use,
                            resources: { water: definition.water || 0, power: definition.power || 0 }
                        };
                            // --- ã‚°ãƒªãƒ«ä½¿ç”¨æ™‚ã®ç¶™ç¶šæ™‚é–“è¨ˆç®— ---
                        if (typeKey === 'grill') {
                            const cookLevel = this.skills.cook.level;
                            // ãƒ¬ãƒ™ãƒ«0: 60åˆ†, ãƒ¬ãƒ™ãƒ«1ã”ã¨: 5åˆ†çŸ­ç¸®
                            duration = Math.max(5, 60 - cookLevel * 5); // æœ€ä½5åˆ†
                            this.currentAction.duration = duration; // â˜…ç¶™ç¶šæ™‚é–“ã‚’ä¸Šæ›¸ã
                            this.showSpeech(`èª¿ç†é–‹å§‹ï¼(${duration}åˆ†)`);
                        }
                        this.lastExpCheckTime = 0;
                        // ä½¿ç”¨é–‹å§‹æ™‚ã«é–¢æ•°ã‚’1å›å®Ÿè¡Œ
                        if (typeKey !== 'grill' && this.currentAction.useFunc) {
                             this.currentAction.useFunc(this);
                        }
                    });
                    return true;
                }
                return false;
            }
            
            // ä¼šè©±ç›¸æ‰‹ã‚’æ¢ã™
            findTalkPartner() {
                for (let other of people) {
                    if (other.id === this.id || other.isWorking || other.currentAction) continue;
                    
                    // è·é›¢ãŒè¿‘ã„ã‹
                    const dist = Math.hypot(this.x - other.x, this.y - other.y);
                    if (dist < TILE_SIZE * 3) { // 3ã‚¿ã‚¤ãƒ«ä»¥å†…
                        // ä»²ãŒæ‚ªã™ããªã„ã‹
                        if ((this.relationships[other.id] || 0) > -50) {
                            return other;
                        }
                    }
                }
                return null;
            }

            // ä¼šè©±é–‹å§‹
            startConversation(other) {
                if (this.currentAction || other.currentAction) return;
                
                // --- å¤‰æ›´: ä»²ã®è‰¯ã•ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã«ç‰¹è³ªã¨èª•ç”Ÿæ—¥ã‚’åŠ å‘³ ---
                const relationship = this.relationships[other.nameKey] || 0;
                
                let baseChange = (Math.random() > 0.5) ? 5 : -3;
                
                // 1. ç‰¹è³ªã«ã‚ˆã‚‹è£œæ­£
                const compatibilityBonus = this.getCompatibilityBonus(other);
                baseChange *= compatibilityBonus;

                // 2. èª•ç”Ÿæ—¥ã«ã‚ˆã‚‹è£œæ­£
                if (this.isBirthday() || other.isBirthday()) {
                    // èª•ç”Ÿæ—¥ä¸­ã¯ã€ä¸ŠãŒã‚‹å ´åˆã¯ +5ã€ä¸‹ãŒã‚‹å ´åˆã¯ /2 (æ¸›å°‘ç·©å’Œ)
                    if (baseChange > 0) {
                        baseChange += 5; 
                    } else {
                        baseChange /= 2; 
                    }
                }
                // ã‚¹ã‚­ãƒ«ã«ã‚ˆã‚‹è£œæ­£
                const myTalkLevel = this.skills.talk.level;
                const otherTalkLevel = other.skills.talk.level;
                
                // ä¼šè©±ã‚¹ã‚­ãƒ«: é«˜ã„ã»ã©ä»²ã®è‰¯ã•å€¤ãŒæ¸›ã‚Šã«ãããªã‚‹ (è² ã®è£œæ­£ã‚’ç·©å’Œ)
                if (baseChange < 0) {
                    baseChange *= (1 - (myTalkLevel * 0.05)); // æœ€å¤§50%æ¸›å°‘ç·©å’Œ (Lv10ã§)
                }
                
                // ã‚²ãƒ¼ãƒ ã‚¹ã‚­ãƒ«: ç›¸æ‰‹ãŒã€Œãƒ²ã‚¿ã‚¯ã€ãªã‚‰ä»²ã®è‰¯ã•å€¤ãŒå¢—ãˆã‚„ã™ããªã‚‹
                if (other.traitKey === 'otaku') {
                    baseChange *= (1 + (this.skills.game.level * 0.05)); // æœ€å¤§50%å¢—åŠ  (Lv10ã§)
                }
                
                // è·æ¥­ã‚¹ã‚­ãƒ«: ç›¸æ‰‹ãŒã€ŒçœŸé¢ç›®ã€ãªã‚‰ä»²ã®è‰¯ã•å€¤ãŒå¢—ãˆã‚„ã™ããªã‚‹
                if (other.traitKey === 'serious') {
                    baseChange *= (1 + (this.skills.job.level * 0.05)); // æœ€å¤§50%å¢—åŠ  (Lv10ã§)
                }
                let change = Math.round(baseChange);
                let newRelationship = Math.max(-100, Math.min(100, relationship + change));
                
                this.relationships[other.nameKey] = newRelationship;
                other.relationships[this.nameKey] = newRelationship;
                
                // ä¼šè©±ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®š (ä¸¡è€…) - changeå€¤ã‚’ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
                const duration = 15; // 15åˆ†ä¼šè©±
                this.currentAction = { type: 'talk', target: other, duration: duration, timer: 0, change: change };
                other.currentAction = { type: 'talk', target: this, duration: duration, timer: 0, change: change };
                this.gainSkillExp('talk', Math.floor(duration / 3)); // 3åˆ†ä¼šè©±ã§1exp
                other.gainSkillExp('talk', Math.floor(duration / 3));
                // ä¼šè©±é–‹å§‹ã®å¹ãå‡ºã—
                this.showSpeech("ã“ã‚“ã«ã¡ã¯ï¼");
                other.showSpeech("ã©ã†ã‚‚ï¼");

                // çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    this.showRelationshipChange(change, other);
                }, duration * MS_PER_GAME_MINUTE * 2); // duration * MS_PER_GAME_MINUTE = ã‚²ãƒ¼ãƒ å†…æ™‚é–“ã€2å€ã¯ãƒãƒƒãƒ•ã‚¡
            }
            getCompatibilityBonus(other) {
                const myTrait = TRAITS[this.traitKey];
                const otherTraitKey = other.traitKey;

                if (myTrait.good.includes(otherTraitKey)) {
                    return 1.5; // ç›¸æ€§è‰¯
                } else if (myTrait.bad.includes(otherTraitKey)) {
                    return 0.5; // ç›¸æ€§æ‚ª
                } else {
                    return 1.0; // æ™®é€š
                }
            }
            // æ–°è¦ãƒ¡ã‚½ãƒƒãƒ‰: é–¢ä¿‚å€¤ã®å¤‰å‹•ã‚’å¹ãå‡ºã—è¡¨ç¤º
            showRelationshipChange(change, otherPerson) {
                let message;
                let otherMessage;
                
                if (change > 0) {
                    message = `${otherPerson.firstName}ã¨ä»²è‰¯ããªã£ãŸï¼ (+${change})`;
                    otherMessage = `${this.firstName}ã¨ä»²è‰¯ããªã£ãŸï¼ (+${change})`;
                } else {
                    message = `${otherPerson.firstName}ã¨æ°—ã¾ãšã„... (${change})`;
                    otherMessage = `${this.firstName}ã¨æ°—ã¾ãšã„... (${change})`;
                }
                
                this.showSpeech(message);
                otherPerson.showSpeech(otherMessage);
            }

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡¦ç†
            handleAction(gameMinutesPassed) {
                this.currentAction.timer += gameMinutesPassed;

                // ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²» (3åˆ†ã”ã¨ã«)
                if (this.currentAction.resources) {
                // å‰å›ã‹ã‚‰ã®çµŒéæ™‚é–“ã§3åˆ†å˜ä½ã®æ¶ˆè²»ã‚’è¨ˆç®—
                const prevIntervals = Math.floor((this.currentAction.timer - gameMinutesPassed) / 3);
                const currentIntervals = Math.floor(this.currentAction.timer / 3);
                const intervalsPassed = currentIntervals - prevIntervals;

                if (intervalsPassed > 0) {
                    gameState.dailyWater += (this.currentAction.resources.water || 0) * intervalsPassed;
                    gameState.dailyPower += (this.currentAction.resources.power || 0) * intervalsPassed;
                    
                    // ä¿®æ­£: ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³ä½¿ç”¨æ™‚ã®çµŒé¨“å€¤ç²å¾—ãƒ­ã‚¸ãƒƒã‚¯
                    if (this.currentAction.target.type === 'laptop') {
                        const expBlockSize = 5; // 5åˆ†ã§1Exp
                        
                        // çµŒéæ™‚é–“ã‚’è¨ˆç®— (duration:åˆæœŸæ™‚é–“, timer:æ®‹ã‚Šæ™‚é–“)
                        // â˜…ã‚¿ã‚¤ãƒãƒ¼ã¯å¢—åŠ ã—ã¦ã„ãæ–¹å¼ (timer: 0 -> duration)
                        const elapsedTime = this.currentAction.timer; 
                        
                        // åˆå›å®Ÿè¡Œæ™‚ã®åˆæœŸåŒ– (lastExpGainTimeãŒæœªå®šç¾©ã®å ´åˆã€0ã«è¨­å®š)
                        if (this.currentAction.lastExpGainTime === undefined) {
                            this.currentAction.lastExpGainTime = 0;
                        }
                        
                        // çµŒé¨“å€¤ç²å¾—ã®åŸºæº–ã¨ãªã‚‹ãƒ–ãƒ­ãƒƒã‚¯æ•°ã‚’è¨ˆç®—
                        const totalExpBlocks = Math.floor(elapsedTime / expBlockSize);
                        const lastExpBlocks = Math.floor(this.currentAction.lastExpGainTime / expBlockSize);
                        
                        const expToGain = totalExpBlocks - lastExpBlocks;

                        if (expToGain > 0) {
                            this.gainSkillExp('game', expToGain); // çµŒé¨“å€¤ã‚’ç²å¾—
                            // æœ€å¾Œã«çµŒé¨“å€¤ã‚’ç²å¾—ã—ãŸã€ŒçµŒéæ™‚é–“ã€ã‚’æ›´æ–°
                            this.currentAction.lastExpGainTime = totalExpBlocks * expBlockSize; 
                        }
                    }
                }
            }

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†
                if (this.currentAction.timer >= this.currentAction.duration) {
                    const target = this.currentAction.target; // Person or Furniture

                    if (target && target.isUsed) { // å®¶å…·ã®å ´åˆ
                        target.isUsed = false; // å®¶å…·ã‚’è§£æ”¾
                    }
                    
                    if (this.currentAction.type === 'talk') {
                        // ç›¸æ‰‹ãŒã¾ã ã‚²ãƒ¼ãƒ å†…ã«å­˜åœ¨ã™ã‚‹ã‹ï¼ˆIDã§peopleé…åˆ—ã‚’æ¤œç´¢ï¼‰
                        const otherExists = people.some(p => p.id === target.id);
                        
                        if (otherExists) { 
                            const relationshipValue = this.relationships[target.nameKey] || 0;
                            if (relationshipValue > -40) {
                                this.stats.fun = Math.min(100, this.stats.fun + 10); // 10å›å¾©
                            }
                        }
                    }
                    // --- ã“ã“ã¾ã§ ---

                    if (target && target.type === 'grill') { // å®¶å…·ã‹ã¤ã‚°ãƒªãƒ«
                        // 1. è³‡é‡‘æ¶ˆè²»
                        gameState.money -= 10;
                        
                        // 2. å®Œæˆåº¦ã‚’æ±ºå®š (0ï½Lvã®ç¯„å›²)
                        const cookLevel = this.skills.cook.level;
                        const quality = Math.floor(Math.random() * (cookLevel + 1));
                        
                        // 3. æ–™ç†ã®å“è³ªã¨é£Ÿæ•°ã‚’è¨­å®š
                        gameState.foodInventory.servings += 4; // 4é£Ÿåˆ†
                        // 1é£Ÿã‚ãŸã‚Šæº€è…¹åº¦: 10*å®Œæˆåº¦+30 (100ä»¥ä¸Šãªã‚‰100)
                        const hungerRecovery = Math.min(100, 10 * quality + 30); 
                        gameState.foodInventory.quality = hungerRecovery; 
                        
                        // 4. èª¿ç†ã‚¹ã‚­ãƒ«çµŒé¨“å€¤ç²å¾—
                        this.gainSkillExp('cook', 12); // 1å›ã§12exp
                        
                        this.showSpeech(`èª¿ç†å®Œäº†ï¼å“è³ª ${quality} ã®æ–™ç†ãŒ4é£Ÿã§ããŸï¼`);
                    }
                    this.currentAction = null;
                }
            }

            checkWorkStart() {
                if (this.job === JOBS.none || this.isWorking || this.currentAction) return;

                const gameTimeMinutes = gameState.time.getHours() * 60 + gameState.time.getMinutes();
                if (gameTimeMinutes >= this.job.start && gameTimeMinutes < this.job.end) {
                    this.isWorking = true;
                    this.element.style.display = 'none'; // ç”»é¢ã‹ã‚‰æ¶ˆã™
                    // --- ä¿®æ­£3: è·æ¥­çµŒé¨“å€¤ (å‰Šé™¤) ---
                    // this.gainSkillExp('job', 5); // (checkWorkEndã«ç§»å‹•)
                    // --- ã“ã“ã¾ã§ ---
                }
            }
            // ä¿å­˜ç®±ã®æ–™ç†ã‚’é£Ÿã¹ã‚‹è©¦è¡Œ
            tryUseFoodInventory() {
                if (gameState.foodInventory.servings > 0) {
                    gameState.foodInventory.servings--;
                    this.stats.hunger = Math.min(100, this.stats.hunger + gameState.foodInventory.quality);
                    this.showSpeech(`ä¿å­˜é£Ÿã‚’é£Ÿã¹ãŸï¼(æ®‹ã‚Š${gameState.foodInventory.servings}é£Ÿ)`);
                    return true;
                }
                return false;
            }
            move(gameMinutesPassed) {
                if (!this.targetPosition) return;
                const charSize = 20; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚µã‚¤ã‚º (CSSã‚ˆã‚Š)
                const maxX = ROOM_WIDTH * TILE_SIZE - charSize;
                const maxY = ROOM_HEIGHT * TILE_SIZE - charSize;
                
                this.targetPosition.x = Math.max(0, Math.min(this.targetPosition.x, maxX));
                this.targetPosition.y = Math.max(0, Math.min(this.targetPosition.y, maxY));
                const dx = this.targetPosition.x - this.x;
                const dy = this.targetPosition.y - this.y;
                const distance = Math.hypot(dx, dy);

                if (distance < this.moveSpeed * gameMinutesPassed) {
                    this.x = this.targetPosition.x;
                    this.y = this.targetPosition.y;
                    const callback = this.targetPosition.callback;
                    this.targetPosition = null;
                    if (callback) callback();
                } else {
                    this.x += (dx / distance) * this.moveSpeed * gameMinutesPassed;
                    this.y += (dy / distance) * this.moveSpeed * gameMinutesPassed;
                }
                this.draw();
            }
            setTargetPosition(x, y, callback = null) {
                this.targetPosition = { x, y, callback };
            }
            setJob(jobKey) {
                this.job = JOBS[jobKey];
                this.showSpeech(`${this.job.name} ã«ãªã£ãŸï¼`);
                updateSelectedPersonUI();
            }
            
            // ä»•äº‹ã®é–‹å§‹ãƒã‚§ãƒƒã‚¯
            checkWorkStart() {
                if (this.job === JOBS.none || this.isWorking || this.currentAction) return;

                const gameTimeMinutes = gameState.time.getHours() * 60 + gameState.time.getMinutes();
                if (gameTimeMinutes >= this.job.start && gameTimeMinutes < this.job.end) {
                    this.isWorking = true;
                    this.element.style.display = 'none'; // ç”»é¢ã‹ã‚‰æ¶ˆã™
                    // --- ä¿®æ­£3: è·æ¥­çµŒé¨“å€¤ (å‰Šé™¤) ---
                    // (checkWorkEndã«ç§»å‹•)
                    // --- ã“ã“ã¾ã§ ---
                }
            }

            // ä»•äº‹ã®çµ‚äº†ãƒã‚§ãƒƒã‚¯
            checkWorkEnd() {
                const gameTimeMinutes = gameState.time.getHours() * 60 + gameState.time.getMinutes();
                if (gameTimeMinutes >= this.job.end || gameTimeMinutes < this.job.start) {
                    this.isWorking = false;
                    this.element.style.display = 'flex'; // å†è¡¨ç¤º
                    const hoursWorked = (this.job.end - this.job.start) / 60;
                    
                    // --- ä¿®æ­£6: æ™‚çµ¦è¨ˆç®— (è·æ¥­ãƒ¬ãƒ™ãƒ«Ã—20ï¼‹å›ºå®šå€¤) ---
                    const basePay = this.job.pay;
                    const levelBonus = this.skills.job.level * 20;
                    const hourlyWage = basePay + levelBonus;
                    const earnings = hoursWorked * hourlyWage;
                    // --- ã“ã“ã¾ã§ ---

                    gameState.money += earnings;

                    // --- ä¿®æ­£3: è·æ¥­çµŒé¨“å€¤ (ã“ã“ã«è¿½åŠ ) ---
                    this.gainSkillExp('job', 5); // 1å›å‡ºå‹¤ã§5exp
                    // --- ã“ã“ã¾ã§ ---
                    
                    this.showSpeech(`ä»•äº‹çµ‚ã‚ã‚Šï¼ ${Math.floor(earnings)}G ç¨¼ã„ã ï¼`);
                    updateUI();
                }
            }
            
            // ç›¸æ‰‹ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆ (ç›¸æ‰‹ã®éš£)
            getInteractionPoint(otherPerson) {
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å·¦ä¸Šåº§æ¨™ã«ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’è¶³ã—ã¦éš£ã®ã‚¿ã‚¤ãƒ«ã®ä¸­å¿ƒã‚’ç‹™ã†
                return { x: otherPerson.x + TILE_SIZE, y: otherPerson.y };
            }
            
            // å¹ãå‡ºã—è¡¨ç¤º
            showSpeech(text) {
                this.speechBubble.innerText = text;
                this.speechBubble.style.opacity = 1;
                setTimeout(() => {
                    this.speechBubble.style.opacity = 0;
                }, 3000); // 3ç§’ã§æ¶ˆãˆã‚‹
            }
            gainSkillExp(skillKey, exp) {
                const skill = this.skills[skillKey];
                if (!skill) return;
                
                skill.exp += exp;
                const currentLevel = skill.level;
                
                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã®ã—ãã„å€¤ï¼ˆç°¡æ˜“çš„ãªè¨­å®š: 1ãƒ¬ãƒ™ãƒ«ã‚ãŸã‚Š100expï¼‰
                const expNeededForNextLevel = (currentLevel + 1) * 100; 

                // ãƒ¬ãƒ™ãƒ«10ãŒæœ€å¤§
                if (currentLevel < 10 && skill.exp >= expNeededForNextLevel) {
                    skill.level++;
                    this.showSpeech(`${skillKey}ã‚¹ã‚­ãƒ«ãŒ${skill.level}ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼`);
                    // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã®çµŒé¨“å€¤ãŒè¶³ã‚Šã‚‹ã‹å†ãƒã‚§ãƒƒã‚¯ï¼ˆé€£ç¶šãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç”¨ï¼‰
                    if (skill.level < 10) {
                        this.gainSkillExp(skillKey, 0); // å†å¸°å‘¼ã³å‡ºã—
                    }
                }
                
                // ãƒ¬ãƒ™ãƒ«10ä»¥ä¸Šã®å ´åˆã€çµŒé¨“å€¤ã¯è“„ç©ã™ã‚‹ãŒãƒ¬ãƒ™ãƒ«ã¯ä¸ŠãŒã‚‰ãªã„
            }
            // æç”»
            draw() {
                this.element.style.transform = `translate(${this.x}px, ${this.y}px)`;
            }
            
            // å‰Šé™¤
            destroy() {
                characterLayerEl.removeChild(this.element);
            }
        }

        /**
         * å®¶å…·ã‚¯ãƒ©ã‚¹
         */
        class Furniture {
            constructor(id, type, gridX, gridY) {
                this.id = id;
                this.type = type; // "laptop", "bed"ãªã©
                this.definition = FURNITURE_TYPES[type];
                this.gridX = gridX;
                this.gridY = gridY;
                this.width = this.definition.width;
                this.height = this.definition.height;
                this.isUsed = false;

                this.draw();
            }
            toSaveData() {
                return {
                    id: this.id,
                    type: this.type,
                    gridX: this.gridX,
                    gridY: this.gridY,
                    // isUsedã¯ä¿å­˜ã—ãªã„ï¼ˆãƒ­ãƒ¼ãƒ‰æ™‚ã«è§£æ”¾çŠ¶æ…‹ã«ãªã‚‹ãŸã‚ï¼‰
                };
            }
            
            // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒ
            static fromSaveData(data) {
                // DOMæç”»ã‚‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹
                const furniture = new Furniture(
                    data.id,
                    data.type,
                    data.gridX,
                    data.gridY
                );
                return furniture;
            }
            // ã‚°ãƒªãƒƒãƒ‰ã«å®¶å…·ã‚’æç”»ï¼ˆè‰²å¡—ã‚Šï¼‰
            draw() {
                this.removeHighlight(); // å¤ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
                const color = FURNITURE_COLORS[this.type] || '#ccc'; // è‰²ã‚’å–å¾—
                
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        const tile = document.getElementById(`tile-${this.gridX + x}-${this.gridY + y}`);
                        if (tile) {
                            tile.classList.add('furniture-tile');
                            tile.dataset.furnitureId = this.id;
                            // --- å¤‰æ›´: è‰²ã‚’è¨­å®š ---
                            tile.style.backgroundColor = color; 
                            // ------------------------
                        }
                    }
                }
            }

            // ã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰å®¶å…·ã®æƒ…å ±ã‚’å‰Šé™¤
            clearGridInfo() {
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        if (roomGrid[this.gridY + y] && roomGrid[this.gridY + y][this.gridX + x] !== undefined) { // ç¯„å›²ãƒã‚§ãƒƒã‚¯ä¿®æ­£
                            roomGrid[this.gridY + y][this.gridX + x] = null;
                        }
                    }
                }
            }

            // å®¶å…·ã‚’ã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰å‰Šé™¤ï¼ˆDOMã¨ãƒ‡ãƒ¼ã‚¿ï¼‰
            remove() {
                this.removeHighlight();
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        const tile = document.getElementById(`tile-${this.gridX + x}-${this.gridY + y}`);
                        if (tile) {
                            tile.classList.remove('furniture-tile');
                            delete tile.dataset.furnitureId;
                            tile.style.backgroundColor = ''; 
                        }
                    } 
                }
                this.clearGridInfo(); // ã‚°ãƒªãƒƒãƒ‰æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
            }


            // å®¶å…·ã®ä½¿ç”¨ä½ç½®ã‚’è¿”ã™ (å®¶å…·ã®å·¦ä¸Š)
            getUsePosition() {
                return { 
                    x: this.gridX * TILE_SIZE, 
                    y: this.gridY * TILE_SIZE 
                };
            }

            // é¸æŠæ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            addHighlight() {
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        const tile = document.getElementById(`tile-${this.gridX + x}-${this.gridY + y}`);
                        if (tile) {
                            tile.classList.add('selected-for-move');
                        }
                    }
                }
            }

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆã®å‰Šé™¤
            removeHighlight() {
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        const tile = document.getElementById(`tile-${this.gridX + x}-${this.gridY + y}`);
                        if (tile) {
                            tile.classList.remove('selected-for-move');
                        }
                    }
                }
            }
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨æ™‚é–“ç®¡ç† ---

        function toggleTime() {
            gameState.isRunning = !gameState.isRunning;
            if (gameState.isRunning) {
                gameState.lastUpdateTimestamp = Date.now();
                timeToggleBtn.innerText = "æ™‚é–“ã‚’æ­¢ã‚ã‚‹"; // æ–‡è¨€å¤‰æ›´
                timeToggleBtn.classList.add('ticking');
                gameLoopRAF = requestAnimationFrame(gameLoop);
            } else {
                timeToggleBtn.innerText = "æ™‚é–“ã‚’é€²ã‚ã‚‹";
                timeToggleBtn.classList.remove('ticking');
                cancelAnimationFrame(gameLoopRAF);
            }
        }

        function gameLoop() {
            if (!gameState.isRunning) return; // å¿µã®ãŸã‚

            const now = Date.now();
            const realDeltaTimeMs = now - gameState.lastUpdateTimestamp;
            gameState.lastUpdateTimestamp = now;
            gameState.accumulatedTimeMs += realDeltaTimeMs;

            // èª°ã‚‚ã„ãªã„å ´åˆã¯3å€é€Ÿ
            const speedMultiplier = (people.length === 0) ? 3 : 1;
            const effectiveMsPerGameMinute = MS_PER_GAME_MINUTE / speedMultiplier;

            while (gameState.accumulatedTimeMs >= effectiveMsPerGameMinute) {
                updateTime(1); // 1ã‚²ãƒ¼ãƒ åˆ†é€²ã‚ã‚‹
                updatePeople(1);
                gameState.accumulatedTimeMs -= effectiveMsPerGameMinute;
            }

            updateUI(); // UIã¯å¸¸ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«è¿‘ã„çŠ¶æ…‹ã§æ›´æ–°

            if (gameState.isRunning) {
                gameLoopRAF = requestAnimationFrame(gameLoop);
            }
        }

        function updateTime(minutesPassed) {
            const oldDate = gameState.time.getDate();
            gameState.time.setMinutes(gameState.time.getMinutes() + minutesPassed);
            const newDate = gameState.time.getDate();

            // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
            if (oldDate !== newDate) {
                // --- ä¿®æ­£5: ãƒªã‚½ãƒ¼ã‚¹ç²¾ç®— (é›»åŠ›=å€¤x0.5, æ°´=å€¤x1) ---
                const powerCost = gameState.dailyPower * 0.5;
                const waterCost = gameState.dailyWater * 1;
                const totalCost = powerCost + waterCost;

                if (gameState.money >= totalCost) {
                    gameState.money -= totalCost;
                } else {
                    // æ‰•ãˆãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ— (æ”¯æ‰•ã„ã‚’ã‚¹ã‚­ãƒƒãƒ—)
                }
                
                // ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ã‚’ãƒªã‚»ãƒƒãƒˆ
                gameState.dailyWater = 0;
                gameState.dailyPower = 0;
                // --- ã“ã“ã¾ã§ ---
            }
        }

        function updatePeople(gameMinutesPassed) {
            // people é…åˆ—ã®ã‚³ãƒ”ãƒ¼ã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒ— (å‰Šé™¤ä¸­ã«ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãŒå£Šã‚Œã‚‹ã®ã‚’é˜²ã)
            // â€»å‰Šé™¤å‡¦ç†(deleteSelectedPerson)ãŒå³æ™‚å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€å®‰å…¨ç­–
            const peopleToUpdate = [...people];
            for (const person of peopleToUpdate) {
                // å‰Šé™¤ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯ (ä¸‡ãŒä¸€)
                if (!people.includes(person)) continue;
                
                person.checkWorkStart();
                person.update(gameMinutesPassed);
            }
        }

        // --- UIæ›´æ–° ---

        function updateUI() {
            // æ™‚åˆ»è¡¨ç¤º
            const days = Math.floor((gameState.time - new Date(2025, 0, 1, 6, 0, 0)) / (1000 * 60 * 60 * 24));
            const hours = String(gameState.time.getHours()).padStart(2, '0');
            const minutes = String(gameState.time.getMinutes()).padStart(2, '0');
            timeDisplayEl.innerText = `æ™‚åˆ»: ${days}æ—¥ç›® ${hours}:${minutes}`;

            // æ‰€æŒé‡‘
            moneyDisplayEl.innerText = `æ‰€æŒé‡‘: ${Math.floor(gameState.money)} G`;

            // ãƒªã‚½ãƒ¼ã‚¹
            resourceDisplayEl.innerText = `æ°´: ${gameState.dailyWater} / é›»: ${gameState.dailyPower} | æ–™ç†: ${gameState.foodInventory.servings}é£Ÿ (æº€è…¹åº¦:${gameState.foodInventory.quality})`;            
            // é¸æŠä¸­ã®äºº
            updateSelectedPersonUI();

            // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤º
            // --- ä¿®æ­£7: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®å¤‰æ›´ ---
            if (gameState.isDesignMode) {
                designModeStatusEl.innerText = selectedFurnitureForMove ? "æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰: å®¶å…·ç§»å‹•ä¸­" : "æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰";
                designModeStatusEl.style.color = '#28a745';
            } else if (selectedFurnitureForMove) {
                 // æ¨¡æ§˜æ›¿ãˆOFFã§ã‚‚ç§»å‹•ä¸­ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                 designModeStatusEl.innerText = "ç§»å‹•å…ˆã®ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„";
                 designModeStatusEl.style.color = '#e69d00';
            } else {
                designModeStatusEl.innerText = "";
            }
            // --- ã“ã“ã¾ã§ ---
        }
        
        function updateSelectedPersonUI() {
            if (selectedPerson) {
                // ä»²ã®è‰¯ã•ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
                let relationshipHTML = '<h5>ä»²ã®è‰¯ã•:</h5>';
                let hasRelationships = false;

                // å…¨å“¡ã«å¯¾ã—ã¦
                for (const other of people) {
                    if (other.id === selectedPerson.id) continue;
                    
                    hasRelationships = true;
                    // --- å¤‰æ›´: nameKeyã‚’ä½¿ç”¨ ---
                    const relationshipValue = selectedPerson.relationships[other.nameKey] || 0;
                    // -100 ~ 100 ã®å€¤ã‚’ 0 ~ 100 ã®è¡¨ç¤ºå¹…ã«å¤‰æ›
                    const barWidth = Math.abs(relationshipValue);
                    // è² ã®å€¤ã®å ´åˆã¯å·¦å¯„ã›ï¼ˆå·¦å´ã‹ã‚‰ä¼¸ã³ã‚‹ï¼‰ã€æ­£ã®å€¤ã®å ´åˆã¯å³å¯„ã›ï¼ˆå³å´ã‹ã‚‰ä¼¸ã³ã‚‹ï¼‰
                    const marginLeft = relationshipValue < 0 ? 50 - barWidth : 50; 
                    const statColor = relationshipValue >= 0 ? '#17a2b8' : '#6c757d'; // é’ç³»: ä»²è‰¯ã—, ç°è‰²ç³»: æ°—ã¾ãšã„
                    
                    // relationship ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã—ã¦ã€ä¸­å¤®ç·šã‚’è¡¨ç¤ºã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ CSSã®ä½™åœ°ã‚’æ®‹ã™
                    relationshipHTML += `
                        <div class="stat-label">${other.lastName} ${other.firstName} (${relationshipValue})</div>
                        <div class="stat-bar relationship" style="background: #e9ecef;">
                            <div style="width: ${barWidth}%; background: ${statColor}; margin-left: ${marginLeft}%; height: 100%;"></div>
                        </div>
                    `;
                }
                
                if (!hasRelationships) {
                    relationshipHTML = '<div>ã¾ã ä»–ã®äººã¯ã„ã¾ã›ã‚“ã€‚</div>';
                }

                let statsHTML = `
                    <h4>${selectedPerson.lastName} ${selectedPerson.firstName}</h4> 
                    <div>è·æ¥­: ${selectedPerson.job.name}</div>
                    <div>ç‰¹è³ª: ${selectedPerson.trait.name}</div>
                    <div class="stat-label">é£Ÿæ¬² (${Math.floor(selectedPerson.stats.hunger)})</div>
                    <div class="stat-bar"><div style="width: ${selectedPerson.stats.hunger}%; background: #f44336;"></div></div>
                    <div class="stat-label">ç¡çœ  (${Math.floor(selectedPerson.stats.energy)})</div>
                    <div class="stat-bar"><div style="width: ${selectedPerson.stats.energy}%; background: #2196F3;"></div></div>
                    <div class="stat-label">æ¸…æ½” (${Math.floor(selectedPerson.stats.hygiene)})</div>
                    <div class="stat-bar"><div style="width: ${selectedPerson.stats.hygiene}%; background: #00BCD4;"></div></div>
                    <div class="stat-label">æ¥½ã—ã• (${Math.floor(selectedPerson.stats.fun)})</div>
                    <div class="stat-bar"><div style="width: ${selectedPerson.stats.fun}%; background: #FFEB3B;"></div></div>
                    <button id="assign-job-modal-btn">ä»•äº‹</button>
                    <button id="delete-person-btn" style="background-color: #dc3545; margin-left: 10px;">å‰Šé™¤</button> <hr style="margin: 10px 0;">
                    <hr style="margin: 10px 0;">
                    <h5>ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«:</h5>
                    <div class="stat-label">ä¼šè©±: Lv ${selectedPerson.skills.talk.level} (Exp: ${selectedPerson.skills.talk.exp})</div>
                    <div class="stat-label">ã‚²ãƒ¼ãƒ : Lv ${selectedPerson.skills.game.level} (Exp: ${selectedPerson.skills.game.exp})</div>
                    <div class="stat-label">è·æ¥­: Lv ${selectedPerson.skills.job.level} (Exp: ${selectedPerson.skills.job.exp})</div>
                    <div class="stat-label">èª¿ç†: Lv ${selectedPerson.skills.cook.level} (Exp: ${selectedPerson.skills.cook.exp})</div>
                    <hr style="margin: 10px 0;">
                    ${relationshipHTML}
                `;
                personDetailsEl.innerHTML = statsHTML;
                
                document.getElementById('assign-job-modal-btn').onclick = () => {
                    openJobModal(selectedPerson);
                };
                document.getElementById('delete-person-btn').onclick = () => {
                    if (confirm(`${selectedPerson.lastName} ${selectedPerson.firstName}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        deleteSelectedPerson();
                    }
                };
            } else {
                // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                personDetailsEl.innerHTML = '<h4>é¸æŠä¸­ã®äºº</h4>ï¼ˆéƒ¨å±‹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠï¼‰'; 
            }
        }
        
        function selectPerson(person) {
            selectedPerson = person;
            updateSelectedPersonUI();
        }

function deleteSelectedPerson() {
    if (!selectedPerson) return;
    
    const deletedId = selectedPerson.id;
    // --- ä¿®æ­£1: nameKeyã‚’é–¢æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§æ­£ã—ãå®šç¾© ---
    const deletedNameKey = selectedPerson.nameKey; 
    
    // 1. DOMã‹ã‚‰å‰Šé™¤
    selectedPerson.destroy();
    
    // 2. peopleé…åˆ—ã‹ã‚‰å‰Šé™¤
    people = people.filter(p => p.id !== deletedId);
    
    // 3. ä»–ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é–¢ä¿‚æ€§ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã•ã‚ŒãŸäººã®æƒ…å ±ã‚’æ¶ˆã™ï¼ˆæ¡ä»¶ä»˜ãï¼‰
    for (const person of people) {
        // deletedNameKeyã¯ã“ã“ã§æ­£ã—ãå‚ç…§ã•ã‚Œã¾ã™
        const relationshipValue = person.relationships[deletedNameKey] || 0; 
        
        // ä»²ã®è‰¯ã•å€¤ãŒ -5 ï½ 5 ã®ç¯„å›²å¤–ãªã‚‰æ®‹ã™
        if (relationshipValue > 5 || relationshipValue < -5) {
            // å‰Šé™¤ã—ãªã„ (å°†æ¥ã®åŒå§“åŒåã®ãŸã‚ã®å¾©å…ƒç”¨)
        } else {
            delete person.relationships[deletedNameKey];
        }

        // --- ä¿®æ­£2: å‰Šé™¤ã•ã‚ŒãŸäººãŒä¼šè©±ã‚„ç§»å‹•ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãªã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã€ãƒªã‚»ãƒƒãƒˆ ---
        // ã“ã®å‡¦ç†ã¯ for ãƒ«ãƒ¼ãƒ—ã®å†…å´ã«å…¥ã‚Œã‚‹ã“ã¨ã§ã€person ãŒå‚ç…§å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
        
        // currentActionã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒå‰Šé™¤ã•ã‚ŒãŸäººè‡ªèº«ã®å ´åˆ
        if (person.currentAction && person.currentAction.target && person.currentAction.target.id === deletedId) {
            // targetãŒPersonã®å ´åˆï¼ˆä¼šè©±ãªã©ï¼‰
            person.currentAction = null;
        } 
        // targetPositionã®targetIdãŒå‰Šé™¤ã•ã‚ŒãŸäººã®IDã®å ´åˆ (â€»targetIdã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ç¾çŠ¶ãªã„ãŒã€å°†æ¥çš„ã«)
        // if (person.targetPosition && person.targetPosition.targetId === deletedId) {
        //     person.targetPosition = null;
        // }
    } // <-- for ãƒ«ãƒ¼ãƒ—ã®çµ‚ã‚ã‚Š

    // 5. é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€UIã‚’æ›´æ–°
    selectedPerson = null;
    updateSelectedPersonUI();
}
        // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç† ---
        function showAddPersonModal() {
            const traitSelect = document.getElementById('p-trait');
            traitSelect.innerHTML = '';
            // ãƒ©ãƒ³ãƒ€ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            let optionRandom = document.createElement('option');
            optionRandom.value = '';
            optionRandom.innerText = 'ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰';
            traitSelect.appendChild(optionRandom);
            
            for (const key in TRAITS) {
                const trait = TRAITS[key];
                const option = document.createElement('option');
                option.value = key;
                option.innerText = trait.name;
                traitSelect.appendChild(option);
            }
            addPersonModal.style.display = 'block';
        }

        function hideAddPersonModal() {
            addPersonModal.style.display = 'none';
        }

        function confirmAddPerson() {
            const firstName = document.getElementById('p-firstname').value || "åç„¡ã—";
            const lastName = document.getElementById('p-lastname').value || "å§“";
            const gender = document.getElementById('p-gender').value;
            const orientation = document.getElementById('p-orientation').value;
            const traitKey = document.getElementById('p-trait').value || null;
            
            // --- ä¿®æ­£1: å§“åã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ ---
            const fullNameExists = people.some(p => p.firstName === firstName && p.lastName === lastName);
            if (fullNameExists) {
                alert("ã‚¨ãƒ©ãƒ¼: åŒã˜å§“åã®äººãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
                return;
            }
            // --- ã“ã“ã¾ã§ ---

            const newId = nextPersonId++;
            const newPerson = new Person(newId, firstName, lastName, gender, orientation, traitKey); 
                   
            // --- ä¿®æ­£2: é–¢ä¿‚æ€§ã®å¾©å…ƒ ---
            const newFullNameKey = `${lastName}_${firstName}`;
            let restoredRelationships = {};

            for (let p of people) {
                let foundOldKey = null;
                // pã®æ—¢å­˜ã®é–¢ä¿‚æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                for (const oldKey in p.relationships) {
                    const keyParts = oldKey.split('_');
                    if (keyParts.length >= 2) {
                        const keyFullName = `${keyParts[0]}_${keyParts[1]}`;
                        // å§“åãŒä¸€è‡´ã—ã€IDãŒç•°ãªã‚‹ï¼ˆã¤ã¾ã‚Šéå»ã®äººç‰©ï¼‰
                        if (keyFullName === newFullNameKey && oldKey !== newPerson.nameKey) {
                            foundOldKey = oldKey;
                            break;
                        }
                    }
                }

                if (foundOldKey) {
                    // å¤ã„é–¢ä¿‚æ€§ã‚’æ–°ã—ã„ã‚­ãƒ¼ã«å¼•ãç¶™ã
                    const relationshipValue = p.relationships[foundOldKey];
                    p.relationships[newPerson.nameKey] = relationshipValue;
                    restoredRelationships[p.nameKey] = relationshipValue; // æ–°ã—ã„äººã‹ã‚‰è¦‹ãŸé–¢ä¿‚æ€§
                    delete p.relationships[foundOldKey]; // å¤ã„ã‚­ãƒ¼ã‚’å‰Šé™¤
                } else {
                    // å¼•ãç¶™ãé–¢ä¿‚æ€§ãŒãªã„å ´åˆã¯0ã§åˆæœŸåŒ–
                    p.relationships[newPerson.nameKey] = 0;
                    restoredRelationships[p.nameKey] = 0;
                }
            }
            newPerson.relationships = restoredRelationships; // å¾©å…ƒï¼ˆã¾ãŸã¯åˆæœŸåŒ–ï¼‰ã—ãŸé–¢ä¿‚æ€§ã‚’è¨­å®š
            // --- ã“ã“ã¾ã§ ---
            
            people.push(newPerson);
            hideAddPersonModal();
        }

        // --- æ¨¡æ§˜æ›¿ãˆãƒ»å®¶å…· ---

        function toggleDesignMode() {
            gameState.isDesignMode = !gameState.isDesignMode;
            if (gameState.isDesignMode) {
                designModeBtn.classList.add('active');
                showDesignModal();
            } else {
                designModeBtn.classList.remove('active');
                hideDesignModal();
                cancelFurnitureMove(); // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«ç§»å‹•ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            }
            updateUI(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
        }

        function showDesignModal() {
            designModal.style.display = 'block';
        }
        
        function hideDesignModal() {
            designModal.style.display = 'none';
        }

        function updateFurnitureSelect() {
            furnitureSelect.innerHTML = '';
            for (const key in FURNITURE_TYPES) {
                const f = FURNITURE_TYPES[key];
                const option = document.createElement('option');
                option.value = key;
                option.innerText = `${f.name} (${f.price} G)`;
                furnitureSelect.appendChild(option);
            }
            updateFurnitureInfo();
        }
        
        function updateFurnitureInfo() {
            const key = furnitureSelect.value;
            if (!key) return;
            const f = FURNITURE_TYPES[key];
            furnitureInfo.innerText = `ä¾¡æ ¼: ${f.price} G | ã‚µã‚¤ã‚º: ${f.width}x${f.height}`;
        }

        // æŒ‡å®šã•ã‚ŒãŸåº§æ¨™ã«å®¶å…·ã‚’è¨­ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canPlaceFurniture(furnitureToPlace, targetX, targetY, excludeId = null) {
            if (targetX < 0 || targetY < 0 || targetX + furnitureToPlace.width > ROOM_WIDTH || targetY + furnitureToPlace.height > ROOM_HEIGHT) {
                return false; // éƒ¨å±‹ã®ç¯„å›²å¤–
            }
            
            for (let y = targetY; y < targetY + furnitureToPlace.height; y++) {
                for (let x = targetX; x < targetX + furnitureToPlace.width; x++) {
                    // ä»–ã®å®¶å…·ã¨é‡ãªã£ã¦ã„ã‚‹ã‹ã€ãŸã ã—é™¤å¤–IDã®å®¶å…·ã¯OK
                    if (roomGrid[y] && roomGrid[y][x] !== null && roomGrid[y][x] !== excludeId) {
                        return false;
                    }
                }
            }
            return true;
        }

        function buyFurniture() {
            const key = furnitureSelect.value;
            const definition = FURNITURE_TYPES[key];
            const x = parseInt(document.getElementById('f-grid-x').value);
            const y = parseInt(document.getElementById('f-grid-y').value);

            if (!canPlaceFurniture(definition, x, y)) {
                alert("æŒ‡å®šã•ã‚ŒãŸå ´æ‰€ã«ã¯å®¶å…·ã‚’è¨­ç½®ã§ãã¾ã›ã‚“ï¼ˆç¯„å›²å¤–ã¾ãŸã¯ä»–ã®å®¶å…·ã¨è¡çªï¼‰ã€‚");
                return;
            }
            
            // è³‡é‡‘ãƒã‚§ãƒƒã‚¯
            if (gameState.money < definition.price) {
                alert("è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            
            // è³¼å…¥å‡¦ç†
            gameState.money -= definition.price;
            const newId = nextFurnitureId++;
            const newFurniture = new Furniture(newId, key, x, y);
            
            // ã‚°ãƒªãƒƒãƒ‰ã«ç™»éŒ²
            for (let i = y; i < y + newFurniture.height; i++) {
                for (let j = x; j < x + newFurniture.width; j++) {
                    roomGrid[i][j] = newFurniture.id;
                }
            }
            
            furniture.push(newFurniture);
            updateUI();
        }

        // å®¶å…·ç§»å‹•ã®é¸æŠ
        function selectFurnitureToMove(furnitureId) {
            cancelFurnitureMove(); // æ—¢ã«é¸æŠä¸­ã®å®¶å…·ãŒã‚ã‚Œã°è§£é™¤
            
            const targetFurniture = furniture.find(f => f.id === furnitureId);
            if (targetFurniture) {
                selectedFurnitureForMove = targetFurniture;
                selectedFurnitureForMove.addHighlight();
                updateUI();
            }
        }

        // å®¶å…·ç§»å‹•ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelFurnitureMove() {
            if (selectedFurnitureForMove) {
                selectedFurnitureForMove.removeHighlight();
                selectedFurnitureForMove = null;
                // --- ä¿®æ­£7: UIæ›´æ–° ---
                updateUI();
                // --- ã“ã“ã¾ã§ ---
            }
        }

        // å®¶å…·ã®ç§»å‹•å®Ÿè¡Œ
        function moveSelectedFurniture(targetX, targetY) {
            if (!selectedFurnitureForMove) return;

            // ç§»å‹•å…ˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!canPlaceFurniture(selectedFurnitureForMove.definition, targetX, targetY, selectedFurnitureForMove.id)) {
                alert("æŒ‡å®šã•ã‚ŒãŸå ´æ‰€ã«ã¯ç§»å‹•ã§ãã¾ã›ã‚“ï¼ˆç¯„å›²å¤–ã¾ãŸã¯ä»–ã®å®¶å…·ã¨è¡çªï¼‰ã€‚");
                return;
            }

            // å¤ã„ä½ç½®ã®ã‚°ãƒªãƒƒãƒ‰æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
            selectedFurnitureForMove.clearGridInfo();

            // æ–°ã—ã„ä½ç½®ã‚’æ›´æ–°
            selectedFurnitureForMove.gridX = targetX;
            selectedFurnitureForMove.gridY = targetY;

            // æ–°ã—ã„ä½ç½®ã®ã‚°ãƒªãƒƒãƒ‰æƒ…å ±ã‚’æ›´æ–°
            for (let y = selectedFurnitureForMove.gridY; y < selectedFurnitureForMove.gridY + selectedFurnitureForMove.height; y++) {
                for (let x = selectedFurnitureForMove.gridX; x < selectedFurnitureForMove.gridX + selectedFurnitureForMove.width; x++) {
                    roomGrid[y][x] = selectedFurnitureForMove.id;
                }
            }
            
            selectedFurnitureForMove.draw(); // DOMä¸Šã®è¡¨ç¤ºã‚’æ›´æ–°
            cancelFurnitureMove(); // ç§»å‹•å®Œäº†ã§é¸æŠè§£é™¤
        }
        
        // --- è·æ¥­ ---
        
        function openJobModal(person) {
            if (!person) return;
            jobModal.style.display = 'block';
            document.getElementById('job-modal-title').innerText = `${person.lastName} ${person.firstName}ã®ä»•äº‹`;
            
            // è·æ¥­é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
            jobSelect.innerHTML = '';
            for (const key in JOBS) {
                const option = document.createElement('option');
                option.value = key;
                option.innerText = JOBS[key].name;
                jobSelect.appendChild(option);
            }
            jobSelect.value = Object.keys(JOBS).find(key => JOBS[key] === person.job) || 'none';
        }

        function assignJob() {
            if (!selectedPerson) return;
            const jobKey = jobSelect.value;
            selectedPerson.setJob(jobKey);
            jobModal.style.display = 'none';
        }
        
        function quitJob() {
            if (!selectedPerson) return;
            selectedPerson.setJob('none');
            jobModal.style.display = 'none';
        }

        // --- åˆæœŸåŒ– ---

        function init() {
            // éƒ¨å±‹ã®ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
            roomGridEl.innerHTML = '';
            for (let y = 0; y < ROOM_HEIGHT; y++) {
                for (let x = 0; x < ROOM_WIDTH; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'grid-tile';
                    tile.id = `tile-${x}-${y}`;
                    tile.dataset.gridX = x; // åº§æ¨™ã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦è¿½åŠ 
                    tile.dataset.gridY = y;
                    roomGridEl.appendChild(tile);
                }
            }
            
            // å®¶å…·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
            updateFurnitureSelect();
            
            // UIåˆæœŸæ›´æ–°
            updateUI();

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            timeToggleBtn.addEventListener('click', toggleTime);
            addPersonBtn.addEventListener('click', showAddPersonModal);
            designModeBtn.addEventListener('click', toggleDesignMode); // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            saveGameBtn.addEventListener('click', saveGame); 
            loadGameBtn.addEventListener('click', loadGame);
            // äººè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('confirm-add-person').addEventListener('click', confirmAddPerson);
            document.getElementById('cancel-add-person').addEventListener('click', hideAddPersonModal);

            // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ€ãƒ«
            furnitureSelect.addEventListener('change', updateFurnitureInfo);
            document.getElementById('buy-furniture-btn').addEventListener('click', buyFurniture);
            document.getElementById('exit-design-mode-btn').addEventListener('click', toggleDesignMode); // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰çµ‚äº†
            
            // ä»•äº‹ãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('assign-job-btn').addEventListener('click', assignJob);
            document.getElementById('quit-job-btn').addEventListener('click', quitJob);
            document.getElementById('cancel-job-btn').addEventListener('click', () => { jobModal.style.display = 'none'; });
            
            // éƒ¨å±‹ã‚³ãƒ³ãƒ†ãƒŠã‚¯ãƒªãƒƒã‚¯ã§é¸æŠè§£é™¤
            document.getElementById('room-container').addEventListener('click', () => {
                selectPerson(null);
            });

            // --- ä¿®æ­£7: ã‚°ãƒªãƒƒãƒ‰ã‚¿ã‚¤ãƒ«ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (å®¶å…·ç§»å‹•ç”¨) ---
            roomGridEl.addEventListener('dblclick', (e) => {
                // if (!gameState.isDesignMode) return; // <-- ã‚¬ãƒ¼ãƒ‰ã‚’å‰Šé™¤

                const targetTile = e.target.closest('.grid-tile');
                if (targetTile && targetTile.dataset.furnitureId) {
                    const furnitureId = parseInt(targetTile.dataset.furnitureId);
                    
                    if (gameState.isDesignMode) {
                        // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ä¸­: å³åº§ã«ç§»å‹•é¸æŠ
                        selectFurnitureToMove(furnitureId);
                    } else {
                        // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰OFF: ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        const targetFurniture = furniture.find(f => f.id === furnitureId);
                        // ç§»å‹•ä¸­ã§ãªãã€å®¶å…·ãŒä½¿ç”¨ä¸­ã§ã‚‚ãªã„ã“ã¨
                        if (targetFurniture && !selectedFurnitureForMove && !targetFurniture.isUsed) { 
                            if (confirm(`${targetFurniture.definition.name} ã‚’ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ (ä½¿ç”¨ä¸­ã®å®¶å…·ã¯ç§»å‹•ã§ãã¾ã›ã‚“)`)) {
                                selectFurnitureToMove(furnitureId);
                                updateUI(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                            }
                        } else if (targetFurniture && targetFurniture.isUsed) {
                            alert("ä½¿ç”¨ä¸­ã®å®¶å…·ã¯ç§»å‹•ã§ãã¾ã›ã‚“ã€‚");
                        }
                    }

                } else if (gameState.isDesignMode) {
                    // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ä¸­ã§å®¶å…·ã®ãªã„å ´æ‰€ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ç§»å‹•é¸æŠè§£é™¤
                    cancelFurnitureMove();
                }
            });

            roomGridEl.addEventListener('click', (e) => {
                // if (!gameState.isDesignMode || !selectedFurnitureForMove) return; // <-- å¤‰æ›´
                
                if (!selectedFurnitureForMove) return; // ç§»å‹•å¯¾è±¡ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

                const targetTile = e.target.closest('.grid-tile');
                if (targetTile) {
                    const gridX = parseInt(targetTile.dataset.gridX);
                    const gridY = parseInt(targetTile.dataset.gridY);
                    
                    moveSelectedFurniture(gridX, gridY);
                    
                    // æ¨¡æ§˜æ›¿ãˆãƒ¢ãƒ¼ãƒ‰OFFã§ç§»å‹•ã—ãŸå ´åˆã€UIã‚’å³æ™‚æ›´æ–°ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
                    if (!gameState.isDesignMode) {
                        updateUI();
                    }
                }
            });
            // --- ã“ã“ã¾ã§ ---
        }

        // --- ã‚²ãƒ¼ãƒ é–‹å§‹ ---
        document.addEventListener('DOMContentLoaded', init);

        // ã‚»ãƒ¼ãƒ–å‡¦ç†
        function saveGame() {
            // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ§‹é€ åŒ–
            const saveData = {
                // 1. åŸºæœ¬çŠ¶æ…‹
                time: gameState.time.getTime(), // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã—ã¦ä¿å­˜
                money: gameState.money,
                dailyWater: gameState.dailyWater,
                dailyPower: gameState.dailyPower,
                nextPersonId: nextPersonId,
                nextFurnitureId: nextFurnitureId,
                foodInventory: gameState.foodInventory,
                
                // 2. äººç‰©ãƒ‡ãƒ¼ã‚¿
                people: people.map(p => p.toSaveData()),
                
                // 3. å®¶å…·ãƒ‡ãƒ¼ã‚¿
                furniture: furniture.map(f => f.toSaveData()),
            };
            
            // JSONæ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            const jsonString = JSON.stringify(saveData, null, 2);
            saveDataArea.value = jsonString;
            alert("ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
        }

        // ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function loadGame() {
            try {
                const jsonString = saveDataArea.value;
                const saveData = JSON.parse(jsonString);

                // ãƒ­ãƒ¼ãƒ‰å‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                resetGameWorld();

                // 1. åŸºæœ¬çŠ¶æ…‹ã‚’å¾©å…ƒ
                gameState.time = new Date(saveData.time);
                gameState.money = saveData.money;
                gameState.dailyWater = saveData.dailyWater;
                gameState.dailyPower = saveData.dailyPower;
                nextPersonId = saveData.nextPersonId;
                nextFurnitureId = saveData.nextFurnitureId;
                gameState.foodInventory = saveData.foodInventory || { servings: 0, quality: 0 };
                
                // 2. äººç‰©ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                people = saveData.people.map(pData => Person.fromSaveData(pData));

                // 3. å®¶å…·ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã€ã‚°ãƒªãƒƒãƒ‰æƒ…å ±ã‚‚å†æ§‹ç¯‰
                furniture = saveData.furniture.map(fData => Furniture.fromSaveData(fData));
                rebuildRoomGrid();

                // 4. ãã®ä»–çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ/æ›´æ–°
                selectPerson(null);
                gameState.isRunning = false; // ãƒ­ãƒ¼ãƒ‰æ™‚ã¯æ™‚é–“ã‚’åœæ­¢
                timeToggleBtn.innerText = "æ™‚é–“ã‚’é€²ã‚ã‚‹";
                timeToggleBtn.classList.remove('ticking');
                if (gameLoopRAF) cancelAnimationFrame(gameLoopRAF); // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢
                
                updateUI();
                alert("ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");

            } catch (e) {
                console.error("ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", e);
                alert("ç„¡åŠ¹ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚");
            }
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹è£œåŠ©é–¢æ•°
        function resetGameWorld() {
            // äººç‰©ã‚’å‰Šé™¤
            for (const person of people) {
                person.destroy();
            }
            people = [];
            
            // å®¶å…·ã‚’å‰Šé™¤ã—ã€ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
            for (const f of furniture) {
                f.remove();
            }
            furniture = [];
            roomGrid = Array(ROOM_HEIGHT).fill(null).map(() => Array(ROOM_WIDTH).fill(null));
        }

        function rebuildRoomGrid() {
            // ã‚°ãƒªãƒƒãƒ‰ã‚’ç©ºã«ã™ã‚‹
            roomGrid = Array(ROOM_HEIGHT).fill(null).map(() => Array(ROOM_WIDTH).fill(null));
            
            for (const f of furniture) {
                for (let y = f.gridY; y < f.gridY + f.height; y++) {
                    for (let x = f.gridX; x < f.gridX + f.width; x++) {
                        if (roomGrid[y] && roomGrid[y][x] !== undefined) {
                            roomGrid[y][x] = f.id;
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
